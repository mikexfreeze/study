/*! waterfall-horizontal - v0.1.0 - 2016-02-14
* https://senntyou.github.io/waterfall-horizontal/
* Copyright (c) 2016 senntyou; Licensed MIT */
(function(t,e,i,s){"use strict";function n(e,i){this.$element=t(e),this.options=t.extend(!0,{},r,i),this.width=0,this.height=0,this.styleQueue=[],this.itemsData=[],this._init()}var o=t(e),a="waterfallHorizontal",r={itemCls:"waterfall-horizontal-item",prefix:"waterfall-horizontal",fitWidth:!0,rowHeight:240,gutterWidth:10,gutterHeight:10,minRow:1,maxRow:s,maxPage:s,bufferPixel:-50,containerStyle:{position:"relative"},resizable:!0,isFadeIn:!1,isAnimated:!1,animationOptions:{},isAutoPrefill:!0,path:s,dataType:"json",params:{},headers:{},loadingMsg:'<div style="text-align:center;padding:10px 0; color:#999;"><img src="data:image/gif;base64,R0lGODlhEAALAPQAAP///zMzM+Li4tra2u7u7jk5OTMzM1hYWJubm4CAgMjIyE9PT29vb6KiooODg8vLy1JSUjc3N3Jycuvr6+Dg4Pb29mBgYOPj4/X19cXFxbOzs9XV1fHx8TMzMzMzMzMzMyH5BAkLAAAAIf4aQ3JlYXRlZCB3aXRoIGFqYXhsb2FkLmluZm8AIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAALAAAFLSAgjmRpnqSgCuLKAq5AEIM4zDVw03ve27ifDgfkEYe04kDIDC5zrtYKRa2WQgAh+QQJCwAAACwAAAAAEAALAAAFJGBhGAVgnqhpHIeRvsDawqns0qeN5+y967tYLyicBYE7EYkYAgAh+QQJCwAAACwAAAAAEAALAAAFNiAgjothLOOIJAkiGgxjpGKiKMkbz7SN6zIawJcDwIK9W/HISxGBzdHTuBNOmcJVCyoUlk7CEAAh+QQJCwAAACwAAAAAEAALAAAFNSAgjqQIRRFUAo3jNGIkSdHqPI8Tz3V55zuaDacDyIQ+YrBH+hWPzJFzOQQaeavWi7oqnVIhACH5BAkLAAAALAAAAAAQAAsAAAUyICCOZGme1rJY5kRRk7hI0mJSVUXJtF3iOl7tltsBZsNfUegjAY3I5sgFY55KqdX1GgIAIfkECQsAAAAsAAAAABAACwAABTcgII5kaZ4kcV2EqLJipmnZhWGXaOOitm2aXQ4g7P2Ct2ER4AMul00kj5g0Al8tADY2y6C+4FIIACH5BAkLAAAALAAAAAAQAAsAAAUvICCOZGme5ERRk6iy7qpyHCVStA3gNa/7txxwlwv2isSacYUc+l4tADQGQ1mvpBAAIfkECQsAAAAsAAAAABAACwAABS8gII5kaZ7kRFGTqLLuqnIcJVK0DeA1r/u3HHCXC/aKxJpxhRz6Xi0ANAZDWa+kEAA7" alt=""><br />Loading...</div>',state:{isDuringAjax:!1,isProcessingData:!1,isResizing:!1,isPause:!1,curPage:1},callbacks:{loadingStart:function(t){t.show()},loadingFinished:function(t,e){e?t.remove():t.fadeOut()},loadingError:function(t){t.html("Data load faild, please try again later.")},renderData:function(e,i){var s,n;return"json"===i||"jsonp"===i?(s=t("#waterfall-horizontal-tpl").html(),n=Handlebars.compile(s),n(e)):e}},debug:!1};n.prototype={constructor:n,_debug:function(){!0===this.options.debug&&("undefined"!=typeof console&&"function"==typeof console.log?1===Array.prototype.slice.call(arguments).length&&"string"==typeof Array.prototype.slice.call(arguments)[0]?console.log(""+Array.prototype.slice.call(arguments)):console.log(Array.prototype.slice.call(arguments)):Function.prototype.bind||"undefined"==typeof console||"object"!=typeof console.log||Function.prototype.call.call(console.log,console,Array.prototype.slice.call(arguments)))},_init:function(t){var e=this.options,i=e.path;return this._resetHeight(),this._setWidth(),this._initContainer(),this.reLayout(t),i?(e.isAutoPrefill&&this._prefill(),e.resizable&&this._doResize(),this._doScroll(),s):(this._debug("Invalid path"),s)},_initContainer:function(){var e=this.options,i=e.prefix;t("body").css({overflow:"auto"}),this.$element.css(this.options.containerStyle).addClass(i+"-container"),this.$element.after('<div id="'+i+'-loading">'+e.loadingMsg+'</div><div id="'+i+'-message" style="text-align:center;color:#999;"></div>'),this.$loading=t("#"+i+"-loading"),this.$message=t("#"+i+"-message")},_getItems:function(t){var e=t.filter("."+this.options.itemCls).css({position:"absolute"});return e},_setWidth:function(){this.width=this._getWidth()},_getWidth:function(){var t=this.options,e=t.fitWidth?this.$element.parent():this.$element,i="BODY"===e[0].tagName?e.width()-20:e.width();return i},_resetHeight:function(){this.height=0},layout:function(t,e){var i,s,n,o,a,r,l,h,A=this,u=A.options,c=A.itemsData,g=u.isFadeIn?A._getItems(t).css({opacity:0}).animate({opacity:1}):A._getItems(t),d=u.isAnimated&&u.state.isResizing?"animate":"css",p=u.animationOptions,f=u.rowHeight,m=u.gutterWidth,y=u.gutterHeight,w=0,_=-1,v=-1,I=A.width,b=!0;for(o=0,l=c.length;l>o;){for(c[o].width||(c[o].width=u.rowHeight),s=c[o].width,r=1;l+1>o+r&&!(s>=I);r++){if(o+r-1===l-1&&I>s){b=!1;break}s+=m+c[o+r].width}i=r,w+=1,_=o+r-1,v=o,s=0,this._placeItems(g,v,i,w,b),o+=r}for(a=0,h=this.styleQueue.length;h>a;a++)n=this.styleQueue[a],n.$el[d](n.style,p);A.height=w*(y+f)-y,this.$element.height(A.height),this.styleQueue=[],this.options.state.isResizing=!1,this.options.state.isProcessingData=!1,e&&e.call(g)},reLayout:function(t){var e=this.$element.find("."+this.options.itemCls);this._resetHeight(),this.layout(e,t)},_placeItems:function(e,i,s,n,o){var a,r,l,h,A,u,c=this,g=t(e[i]),d=c.options,p=c.itemsData,f=d.rowHeight,m=d.gutterWidth,y=d.gutterHeight,w=0,_=(n-1)*(y+f);if(1===s&&o)a={left:0,top:_,width:c.width,height:f},this.styleQueue.push({$el:g,style:a});else if(o){for(h=p[i].width,r=1;s>r;r++)h+=y+p[i+r].width;for(u=c.width/h,r=0;s-1>r;r++)A=Math.floor(p[i+r].width*u),a={left:w,top:_,width:A,height:f},this.styleQueue.push({$el:t(e[i+r]),style:a}),w+=A+m;A=c.width-w,a={left:w,top:_,width:A,height:f},this.styleQueue.push({$el:t(e[i+s-1]),style:a})}else for(l=0;s>l;l++)A=p[i+l].width,a={left:w,top:_,width:A,height:f},this.styleQueue.push({$el:t(e[i+l]),style:a}),w+=A+m},prepend:function(t,e){this._handleResponse(t,e,!1)},append:function(t,e){this._handleResponse(t,e)},removeItems:function(e,i){var s,n,o,a,r,l=this;if("number"==typeof e)l.itemsData.splice(e,1),l.$element.find("."+l.options.itemCls).eq(e).remove();else if(t.isArray(e))for(e=e.sort(function(t,e){var i=parseInt(t),s=parseInt(e);return i==s?0:s>i?-1:1}),s=0,n=e.length;n>s;s++)l.itemsData.splice(e[s]-s,1),l.$element.find("."+l.options.itemCls).eq(e[s]-s).remove();else{for(o=l.$element.find(e),s=0,n=o.length;n>s;s++)a=t(o[s]),r=a.index(),l.itemsData.splice(r-s,1);o.remove()}this.reLayout(i)},option:function(e,i){t.isPlainObject(e)&&(this.options=t.extend(!0,this.options,e),"function"==typeof i&&i(),this._init())},pause:function(t){this.options.state.isPause=!0,"function"==typeof t&&t()},resume:function(t){this.options.state.isPause=!1,"function"==typeof t&&t()},_requestData:function(e){var i,n=this,o=n.options,a=o.maxPage,r=o.state.curPage++,l=o.path,h=o.dataType,A=o.params,u=o.headers;return a!==s&&r>a?(o.state.isBeyondMaxPage=!0,o.callbacks.loadingFinished(n.$loading,o.state.isBeyondMaxPage),s):(i="function"==typeof l?l(r):l.join(r),n._debug("heading into ajax",i+t.param(A)),o.callbacks.loadingStart(n.$loading),o.state.isDuringAjax=!0,o.state.isProcessingData=!0,t.ajax({url:i,data:A,headers:u,dataType:h,success:function(t){n._handleResponse(t,e),n.options.state.isDuringAjax=!1},error:function(){n._responeseError("error")}}),s)},_handleResponse:function(e,i,n){var o,a,r=this,l=r.options,h=t.trim(l.callbacks.renderData(e,l.dataType)),A=t(h);if(l.checkImagesLoaded,n===s&&(n=!0),n){for(o=0,a=e.items.length;a>o;o++)r.itemsData.push(e.items[o]);r.$element.append(A)}else{for(a=e.items.length-1;a>-1;a--)r.itemsData.unshift(e.items[a]);r.$element.prepend(A)}r.reLayout(i),r.options.callbacks.loadingFinished(r.$loading,r.options.state.isBeyondMaxPage)},_responeseError:function(t){this.$loading.hide(),this.options.callbacks.loadingError(this.$message,t),"end"!==t&&"error"!==t&&(t="unknown"),this._debug("Error",t)},_nearbottom:function(){var t=this,e=t.options,i=o.scrollTop()+o.height()-t.$element.offset().top-t.height;return this._debug("math:",i),i>e.bufferPixel},_prefill:function(){this.$element.height()<=o.height()&&this._scroll()},_scroll:function(){var t=this,e=t.options,i=e.state;i.isProcessingData||i.isDuringAjax||i.isInvalidPage||i.isPause||this._nearbottom()&&this._requestData(function(){setTimeout(function(){t._scroll()},100)})},_doScroll:function(){var t,e=this;o.bind("scroll",function(){t&&clearTimeout(t),t=setTimeout(function(){e._scroll()},100)})},_resize:function(){var t=this.width,e=this._getWidth();e!==t&&(this.options.state.isResizing=!0,this.width=e,this.reLayout(),this._prefill())},_doResize:function(){var t,e=this;o.bind("resize",function(){t&&clearTimeout(t),t=setTimeout(function(){e._resize()},100)})}},t.fn[a]=function(e){if("string"==typeof e){var i=Array.prototype.slice.call(arguments,1);this.each(function(){var n=t.data(this,"plugin_"+a);return n?t.isFunction(n[e])&&"_"!==e.charAt(0)?(n[e].apply(n,i),s):(n._debug('no such method "'+e+'"'),s):(n._debug("instance is not initialization"),s)})}else this.each(function(){t.data(this,"plugin_"+a)||t.data(this,"plugin_"+a,new n(this,e))});return this}})(jQuery,window,document);